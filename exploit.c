/*
 * Toy example / demonstration of some printf related exploits
 *
 * See:
 *   https://owasp.org/www-community/attacks/Format_string_attack
 */
#include <stdbool.h>
#include <stdio.h>


#define LOG_LEVEL_DEBUG 5
//#define LOG_LEVEL LOG_LEVEL_DEBUG

typedef struct {
  char log[64];
  bool correct_code_entered;
} AuthorizationInfo;

// Usage: ./a.out user_name code
int main(int argc, char** argv) {
  int correct_code = 12345; // 0x3039
  char* user_name = argv[1];
  int code = atoi(argv[2]);
#ifdef V1
  loginV1(user_name, code, correct_code);
#elif V2
  loginV2(user_name, code, correct_code);
#elif V3a
  loginV3a(user_name, code, correct_code);
#elif V3b
  loginV3b(user_name, code, correct_code);
#elif V4
  loginV4(user_name, code, correct_code);
#else
  printf("Version not found");
#endif
}

void handleAuthorization(AuthorizationInfo* authorizationInfo) {
  printf(authorizationInfo->log);
  if (authorizationInfo->correct_code_entered) {
    printf("Access granted\n");
  } else {
    printf("Access denied\n");
  }

#if LOG_LEVEL >= LOG_LEVEL_DEBUG
  printf("authorizationInfo: {\nlog:\"%s\",\n, correct_code_entered: %d\n}\n", authorizationInfo->log, authorizationInfo->correct_code_entered);
  printf("authorizationInfo.log[62]: %d\n", authorizationInfo->log[62]);
  printf("authorizationInfo.log[63]: %d\n", authorizationInfo->log[63]);
  printf("authorizationInfo.log[64]: %d\n", authorizationInfo->log[64]);
  printf("&authorizationInfo.log: %p\n", &authorizationInfo->log);
  printf("&authorizationInfo.log[64]: %p\n", &authorizationInfo->log[64]);
  printf("&authorizationInfo.correct_code_entered: %p\n", &authorizationInfo->correct_code_entered);
#endif
}

void loginV1(char* user_name, int code, int correct_code) {
  AuthorizationInfo authorizationInfo;
  authorizationInfo.correct_code_entered = code == correct_code;
  sprintf(authorizationInfo.log, "Login attempt user_name: \"%s\"\n", user_name);

  handleAuthorization(&authorizationInfo);
}

void loginV2(char* user_name, int code, int correct_code) {
  char truncated_user_name[30];
  char buf[64];

  AuthorizationInfo authorizationInfo;
  authorizationInfo.correct_code_entered = code == correct_code;
  // Truncate user input
  strncpy(truncated_user_name, user_name, 30);
  sprintf(buf, "Login attempt user_name: \"%s\"\n", truncated_user_name);
  sprintf(authorizationInfo.log, buf);

  handleAuthorization(&authorizationInfo);
}

void loginV3a(char* user_name, int code, int correct_code) {
  char truncated_user_name[30];
  char buf[64];

  AuthorizationInfo authorizationInfo;
  authorizationInfo.correct_code_entered = code == correct_code;
  // Truncate user input
  strncpy(truncated_user_name, user_name, 30);
  sprintf(buf, "Login attempt user_name: \"%s\"\n", truncated_user_name);
  // Use strcpy to copy strings, not sprintf
  strcpy(authorizationInfo.log, buf);

  handleAuthorization(&authorizationInfo);
}

void loginV3b(char* user_name, int code, int correct_code) {
  char truncated_user_name[30];

  AuthorizationInfo authorizationInfo;
  authorizationInfo.correct_code_entered = code == correct_code;
  // Truncate user input
  strncpy(truncated_user_name, user_name, 30);
  // Prefer snprintf and also avoid pointless copying
  snprintf(authorizationInfo.log, 64, "Login attempt user_name: \"%s\"\n", truncated_user_name);

  handleAuthorization(&authorizationInfo);
}

void loginV4(char* user_name, int code, int correct_code) {
  char truncated_user_name[30];

  AuthorizationInfo authorizationInfo;
  authorizationInfo.correct_code_entered = code == correct_code;
  // Truncate user input
  strncpy(truncated_user_name, user_name, 30);
  // Prefer snprintf and also avoid pointless copying
  snprintf(authorizationInfo.log, 64, "Login attempt user_name: \"%s\"\n", truncated_user_name);

  handleAuthorizationV4(&authorizationInfo);
}

void handleAuthorizationV4(AuthorizationInfo* authorizationInfo) {
  // Don't pass user input as format string
  printf("%s", authorizationInfo->log);
  if (authorizationInfo->correct_code_entered) {
    printf("Access granted\n");
  } else {
    printf("Access denied\n");
  }
}

/* Attack that overflows log buffer and into correct_code_entered
gcc exploit.c -DV1 -w -O0 && ./a.out 1234567-1234567-1234567-1234567-12345 0
                   ^  ^              ^
                   |  |              \-results in the following, 65 character long log:
                   |  |              \-`Login attempt user_name: "1234567-1234567-1234567-1234567-12345"\n`
                   |  |              \-this overflows the newline char (10) into the correct_code_entered
                   |  \-turn off buffer overflow detection
                   \-disable warning about dangerous use of printf
*/

/* Attack that overflows log buffer and into correct_code_entered
gcc exploit.c -DV2 -w -O0 && ./a.out %37d 0
                   ^  ^              ^
                   |  |              \-expands to 37-digit long string if used as format-string
                   |  \-turn off buffer overflow detection
                   \-disable warning about dangerous use of printf
*/


/* Attack that leaks local variables
gcc exploit.c -DV3 -w -O0 && ./a.out %p%p%p%p%p%p%p%p%p%p%p 3735928559
                   ^  ^              ^                      ^-0xdeadbeef
                   |  |              \-exploit varargs handling to read out stack
                   |  \-keep output predictable for easier demonstration
                   \-disable warning about dangerous use of printf
*/
